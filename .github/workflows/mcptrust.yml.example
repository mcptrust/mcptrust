# MCPTrust CI Workflow Template
# Copy to .github/workflows/mcptrust.yml
#
# Prereqs:
# - mcp-lock.json committed
# - mcp-lock.json.sig committed
# - public.key committed
#
# If server can't run in CI, remove "Detect drift".

name: MCPTrust

on:
  pull_request:
    branches: [main, master]

env:
  # REQUIRED: Your server command
  # Add deps step if needed (npm ci, etc.)
  MCP_SERVER_COMMAND: "npx -y @modelcontextprotocol/server-filesystem /tmp"
  
  # Optional: Customize paths if needed
  LOCKFILE_PATH: "mcp-lock.json"
  SIG_PATH: "mcp-lock.json.sig"
  PUBLIC_KEY_PATH: "public.key"

permissions:
  contents: read
  pull-requests: write

jobs:
  mcptrust:
    name: MCPTrust Security Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.6.0

      - name: Setup Go
        uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff # v5.2.0
        with:
          go-version: "1.22"
          cache: false

      - name: Install mcptrust
        run: go install github.com/mcptrust/mcptrust/cmd/mcptrust@v0.1.0

      - name: Verify lockfile signature
        run: |
          mcptrust verify \
            --key "${{ env.PUBLIC_KEY_PATH }}" \
            --lockfile "${{ env.LOCKFILE_PATH }}" \
            --signature "${{ env.SIG_PATH }}"

      - name: Detect drift
        id: diff
        shell: bash
        run: |
          set +e
          mcptrust diff \
            --lockfile "${{ env.LOCKFILE_PATH }}" \
            -- bash -lc "${{ env.MCP_SERVER_COMMAND }}" > diff_output.txt 2>&1
          EXIT_CODE=$?
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          if [ $EXIT_CODE -ne 0 ]; then
            echo "::error::MCPTrust detected capability drift"
            cat diff_output.txt
          fi
          exit $EXIT_CODE

      - name: Post PR comment on drift
        if: failure() && steps.diff.outputs.exit_code != '0'
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7.0.1
        env:
          MCP_SERVER_COMMAND: ${{ env.MCP_SERVER_COMMAND }}
          LOCKFILE_PATH: ${{ env.LOCKFILE_PATH }}
        with:
          script: |
            const fs = require('fs');
            const { MCP_SERVER_COMMAND, LOCKFILE_PATH } = process.env;
            let diffOutput = '';
            try {
              diffOutput = fs.readFileSync('diff_output.txt', 'utf8');
            } catch (e) {
              diffOutput = 'Could not read diff output';
            }
            if (diffOutput.length > 60000) {
              diffOutput = diffOutput.substring(0, 60000) + '\n... (truncated)';
            }
            
            const body = `## ‚ö†Ô∏è MCPTrust detected capability drift

            **Command:**
            \`\`\`
            mcptrust diff --lockfile ${LOCKFILE_PATH} -- bash -lc "${MCP_SERVER_COMMAND}"
            \`\`\`

            **Output:**
            \`\`\`
            ${diffOutput}
            \`\`\`

            If intentional, re-lock and commit:
            \`\`\`bash
            mcptrust lock -- bash -lc "${MCP_SERVER_COMMAND}"
            mcptrust sign
            git add mcp-lock.json mcp-lock.json.sig
            \`\`\`

            üìñ [Docs](https://github.com/mcptrust/mcptrust)`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
